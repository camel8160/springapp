<ui:composition xmlns="http://www.w3.org/1999/xhtml"
                xmlns:ui="http://java.sun.com/jsf/facelets"
                xmlns:h="http://java.sun.com/jsf/html"
                xmlns:f="http://java.sun.com/jsf/core"
                xmlns:p="http://primefaces.org/ui"
                template="/WEB-INF/template.xhtml">

    <ui:define name="title">Presupuestos</ui:define>

    <ui:define name="content">
	<h:form>
			<p:growl id="growl" sticky="true" autoUpdate="true" />
            <div class="ui-fluid">
                <div class="ui-g">
                    <div class="ui-g-12">
                        <div class="card">
                            <h1>Creación presupuesto</h1>
                            <p:panelGrid columns="4" columnClasses="ui-grid-col-2,ui-grid-col-4,ui-grid-col-2,ui-grid-col-4" layout="grid" 
                            		styleClass="ui-panelgrid-blank" style="border:0px none; background-color:transparent;">
                                
                                <p:outputLabel for="txtNombre" value="Nombre"/>
                                <p:inputText id="txtNombre" value="#{presupuestoBB.presupuesto.nombre}" maxlength="50"/>
                                
                                <p:outputLabel for="txtDescripcion" value="Descripción"/>
                                <p:inputText id="txtDescripcion" value="#{presupuestoBB.presupuesto.descripcion}" maxlength="100"/>
                                
                                <p:outputLabel for="selClasificacion" value="Clasificación"/>
                                <p:selectOneMenu id="selClasificacion" value="#{presupuestoBB.presupuesto.clasificacion}"
                                		 filter="true">
                                    <f:selectItem itemLabel="Seleccione" itemValue="" />
                                    <f:selectItems value="#{presupuestoBB.listasGenericas.lstClasificacionPpto}" />
                                </p:selectOneMenu>
                                
                                <p:outputLabel for="selCentroCosto" value="Centro costo"/>
                                <p:selectOneMenu id="selCentroCosto" value="#{presupuestoBB.presupuesto.centroCosto.id}"
                                		 filter="true">
                                    <f:selectItem itemLabel="Seleccione" itemValue="" />
                                    <f:selectItems value="#{presupuestoBB.listaCentroCostos}" var="cc" 
                                    		itemValue="#{cc.id}" itemLabel="#{cc.centroCosto}"/>
                                    <p:ajax update="@form" listener="#{presupuestoBB.cargarListaCuentas('NO')}" process="@form" />
                                </p:selectOneMenu>
                                
                                <p:outputLabel for="selCuenta" value="Cuenta"/>
                                <p:selectOneMenu id="selCuenta" value="#{presupuestoBB.presupuesto.cuenta.id}"
                                		 filter="true">
                                    <f:selectItem itemLabel="Seleccione" itemValue="" />
                                    <f:selectItems value="#{presupuestoBB.listaCuentas}" var="cc" 
                                    		itemValue="#{cc.id}" itemLabel="#{cc.cuentaNombre}"/>
                                </p:selectOneMenu>
                                
                                <p:outputLabel for="txtAnio" value="Año"/>
                                <p:inputNumber id="txtAnio" value="#{presupuestoBB.presupuesto.anio}"
                                		 maxValue="2999" size="10" minValue="0"/>
                                		 
                                <p:outputLabel for="txtTipo" value="Tipo"/>
                                <p:selectOneMenu id="txtTipo" value="#{presupuestoBB.presupuesto.tipo}"
                                		 filter="true">
                                    <f:selectItem itemLabel="Seleccione" itemValue="" />
                                    <f:selectItems value="#{presupuestoBB.listasGenericas.lstTipoPresupuesto}" />
                                    <p:ajax update="@form" listener="#{presupuestoBB.cambioTipo}" process="@form" />
                                </p:selectOneMenu>
                                
                                <p:outputLabel rendered="#{not empty presupuestoBB.presupuesto.tipo}"
                                		value="#{presupuestoBB.presupuesto.tipo eq 'Mensual' ? 'Mes inicial' : 'Campaña inicial'}"/>
                                <p:selectOneMenu id="txtMesCam" value="#{presupuestoBB.presupuesto.mesCampania}"
                                		 filter="true" rendered="#{not empty presupuestoBB.presupuesto.tipo and presupuestoBB.presupuesto.tipo eq 'Mensual'}">
                                    <f:selectItem itemLabel="Seleccione" itemValue="" />
                                    <f:selectItems value="#{presupuestoBB.listasGenericas.lstMeses}"  />
                                </p:selectOneMenu>
                                <p:inputNumber id="txtMesCam2" value="#{presupuestoBB.presupuesto.mesCampania}"
                                		 maxValue="9999" size="10"
                                		 rendered="#{not empty presupuestoBB.presupuesto.tipo and presupuestoBB.presupuesto.tipo eq 'Campañal'}"/>
                                
                            </p:panelGrid>
                            
                            <div class="ui-g">
                                <ui:repeat var="pr" value="#{presupuestoBB.presupuesto.detalle}" varStatus="myVarStatus">
                                	<div class="ui-g-3 ui-m-6">
                                		<div align="center">
                                			<table>
                                				<tr><td align="center" colspan="2">
                                					<p:outputLabel value="#{presupuestoBB.presupuesto.tipo eq 'Mensual' ? 'Mes ' : 'Campaña '} #{myVarStatus.index+1}"/>
                                				</td></tr>
                                				<tr><td align="center">
                                					<p:inputNumber value="#{pr.valor}" size="20"/>
                                				</td>
                                				<td>
                                					<p:commandButton id="btnEliminar11" value="X" 
					                                	actionListener="#{presupuestoBB.eliminarRegistro1(myVarStatus.index)}" 
					                                	update="@form" 
					                                	style="max-width:150px;"/>
                                				</td></tr>
                                			</table>
                                		</div>
                                	</div>
                                </ui:repeat>
                                
                                <div class="ui-g-12">
                                	<p:commandButton id="btnAddMes" value="Agregar Registro" 
	                                	actionListener="#{presupuestoBB.agregarRegistro1}" 
	                                	update="@form" icon="ui-icon-check fa fa-check Fs14 White" 
	                                	style="max-width:150px;"
	                                	rendered="#{not empty presupuestoBB.presupuesto.detalle}"/>
                                	<p:spacer width="10px" height="0px" />
                                	<p:commandButton id="btnGuardar" value="Guardar" 
	                                	actionListener="#{presupuestoBB.addPresupuesto}" 
	                                	update="@form" icon="ui-icon-check fa fa-check Fs14 White" 
	                                	style="max-width:150px;"/>
                                </div>
                            </div>
                            
                        </div>
                        
                        <div class="card">
                            <h1>Listado de Presupuestos</h1>
                            <p:dataTable id="tblPresupuestos" var="presupuesto" value="#{presupuestoBB.listaPresupuestos}" reflow="true" 
                            		selectionMode="single" rowKey="#{presupuesto.id}"
                            		emptyMessage="No se encontraron registros."
									scrollable="false" paginatorPosition="bottom"
									rows="10" rowsPerPageTemplate="5,10,20,50"
									selection="#{presupuestoBB.detalle}"
									currentPageReportTemplate="Páginas {totalPages}.  registros {totalRecords}"
									paginatorTemplate="{CurrentPageReport} {FirstPageLink} {PreviousPageLink} {PageLinks} {NextPageLink} {LastPageLink} {RowsPerPageDropdown}" 
									paginator="true">
									
								<p:ajax event="rowSelect" update="@form" listener="#{presupuestoBB.verDetalle}" />
									
                                <f:facet name="header">
                                    Presupuestos
                                </f:facet>

                                <p:column headerText="Nombre" sortBy="#{presupuesto.nombre}" width="30%"
                                		 filterMatchMode="contains" filterBy="#{presupuesto.nombre}">
                                    <h:outputText value="#{presupuesto.nombre}" />
                                </p:column>
                                
                                <p:column headerText="Descripción" sortBy="#{presupuesto.descripcion}" width="40%"
                                		 filterMatchMode="contains" filterBy="#{presupuesto.descripcion}">
                                    <h:outputText value="#{presupuesto.descripcion}" />
                                </p:column>
                                
                                <p:column headerText="Clasificación" sortBy="#{presupuesto.clasificacion}" width="15%"
                                		 filterMatchMode="contains" filterBy="#{presupuesto.clasificacion}">
                                    <h:outputText value="#{presupuesto.clasificacion}" />
                                </p:column>
                                
                                <p:column headerText="Centro costo" sortBy="#{presupuesto.centroCosto.centroCosto}" width="40%"
                                		 filterMatchMode="contains" filterBy="#{presupuesto.centroCosto.centroCosto}">
                                    <h:outputText value="#{presupuesto.centroCosto.centroCosto}" />
                                </p:column>
                                
                                <p:column headerText="Cuenta" sortBy="#{presupuesto.cuenta.cuentaNombre}" width="40%"
                                		 filterMatchMode="contains" filterBy="#{presupuesto.cuenta.cuentaNombre}">
                                    <h:outputText value="#{presupuesto.cuenta.cuentaNombre}" />
                                </p:column>
                                
                                <p:column headerText="Año" sortBy="#{presupuesto.anio}" width="15%">
                                     <h:outputText value="#{presupuesto.anio}" />
                                </p:column>

                                <p:column headerText="Tipo" sortBy="#{presupuesto.tipo}" width="15%">
                                     <h:outputText value="#{presupuesto.tipo}" />
                                </p:column>
                                
                                <p:column headerText="Mes/Campaña inicial" sortBy="#{presupuesto.mesCampania}" width="15%">
                                     <h:outputText value="#{presupuesto.mesCampania}" rendered="#{presupuesto.tipo eq 'Campañal'}" />
                                     <h:outputText value="#{presupuestoBB.listasGenericas.getNombreMes(presupuesto.mesCampania)}" rendered="#{presupuesto.tipo eq 'Mensual'}" />
                                </p:column>
                                
                                <p:column headerText="Estado" sortBy="#{presupuesto.estado}" width="15%">
                                     <h:outputText value="#{presupuestoBB.listasGenericas.getNombreEstado(presupuesto.estado)}" />
                                </p:column>
                                
                                <p:column headerText="Acciones" width="15%">
                                    <p:splitButton value="Accion" icon="fa fa-edit">
								        <p:menuitem value="Actualizar" rendered="#{presupuesto.estado eq 'PENDIENTE'}"
								        			actionListener="#{presupuestoBB.setSelectedPresupuesto(presupuesto)}"  
								        			update=":#{p:component('dlgActualizar')} :#{p:component('tblPresupuestos')}" oncomplete="PF('dlgActualizar').show();"
								        			icon="ui-icon-arrowrefresh-1-w" >
								        	
								        </p:menuitem>
								        <p:menuitem value="Eliminar" actionListener="#{presupuestoBB.setSelectedPresupuesto(presupuesto)}" 
								        			update=":#{p:component('dlgEliminar')}" oncomplete="PF('dlgEliminar').show();"
								        			icon="ui-icon-close" >
								        </p:menuitem>
								        <p:menuitem value="Enviar" rendered="#{presupuesto.estado eq 'PENDIENTE'}"
								        			actionListener="#{presupuestoBB.setSelectedPresupuesto(presupuesto)}" 
								        			update=":#{p:component('dlgEnviar')}" oncomplete="PF('dlgEnviar').show();"
								        			icon="ui-icon-send" >
								        </p:menuitem>
								    </p:splitButton>
                                </p:column>
                            </p:dataTable>
                            
                            <div style="display:#{empty presupuestoBB.detalle.detalle ? 'none;' : 'block;'}">
	                            <br/><br/>
	                            
	                            <!-- Detalle del presupuesto -->
	                            <h1>Detalle</h1>
	                            <div class="ui-g">
		                            <ui:repeat var="det" value="#{presupuestoBB.detalle.detalle}" varStatus="myVarStatus">
		                            	<div class="ui-g-3">
		                            		<div align="center">
	                                			<table>
	                                				<tr><td align="center" colspan="2">
	                                					#{presupuestoBB.detalle.tipo eq 'Mensual' ? 'Mes ' : 'Campaña '} #{myVarStatus.index+1}
	                                				</td></tr>
	                                				<tr><td align="center">
	                                					<p:inputNumber value="#{det.valor}" readonly="#{presupuestoBB.detalle.estado eq 'PENDIENTE'}"/>
	                                				</td>
                                				<td>
                                					<p:commandButton id="btnEliminar22" value="X" 
                                						rendered="#{presupuestoBB.detalle.estado eq 'PENDIENTE'}"
					                                	actionListener="#{presupuestoBB.eliminarRegistro2(myVarStatus.index)}" 
					                                	update="@form" 
					                                	style="max-width:150px;"/>
                                				</td></tr>
	                                			</table>
	                                		</div>
		                            	</div>
		                            </ui:repeat>
		                            
		                            <div class="ui-g-12">
		                            	<p:commandButton id="btnAddMes2" value="Agregar Registro" 
		                                	actionListener="#{presupuestoBB.agregarRegistro2}" 
		                                	update="@form" icon="ui-icon-check fa fa-check Fs14 White" 
		                                	rendered="#{presupuestoBB.detalle.estado eq 'PENDIENTE'}"
		                                	style="max-width:150px;"/>
	                                	<p:spacer width="10px" height="0px" />
	                                	<p:commandButton id="btnGuardar2" value="Actualizar registros" 
		                                	actionListener="#{presupuestoBB.actualizarValores}" 
		                                	rendered="#{presupuestoBB.detalle.estado eq 'PENDIENTE'}"
		                                	update="@form" icon="ui-icon-check fa fa-check Fs14 White" 
		                                	style="max-width:180px;"/>
		                            </div>
		                            
	                            </div>
                            </div>
                        </div>
                        
                        <!-- Observaciones -->
                        <div class="card" style="display:#{empty presupuestoBB.detalle.observaciones ? 'none;' : 'block;'}">
                            <h1>Histórico de observaciones</h1>
                            <p:dataTable id="tblObservaciones" var="obs" value="#{presupuestoBB.detalle.observaciones}" reflow="true" 
                            		rendered="#{not empty presupuestoBB.detalle.observaciones}"
                            		emptyMessage="No se encontraron registros."
									scrollable="false" paginatorPosition="bottom"
									rows="10" rowsPerPageTemplate="5,10,20,50"
									currentPageReportTemplate="Páginas {totalPages}.  registros {totalRecords}"
									paginatorTemplate="{CurrentPageReport} {FirstPageLink} {PreviousPageLink} {PageLinks} {NextPageLink} {LastPageLink} {RowsPerPageDropdown}" 
									paginator="true">
									
									
                                <f:facet name="header">
                                    Observaciones
                                </f:facet>

                                <p:column headerText="Observación" sortBy="#{obs.observacion}" width="30%"
                                		 filterMatchMode="contains" filterBy="#{obs.observacion}">
                                    <h:outputText value="#{obs.observacion}" />
                                </p:column>
                                
                                <p:column headerText="Usuario envia" sortBy="#{obs.usuarioEnvia.nombre}" width="15%"
                                		 filterMatchMode="contains" filterBy="#{obs.usuarioEnvia.nombre}">
                                    <h:outputText value="#{obs.usuarioEnvia.nombre}" />
                                </p:column>
                                
                                <p:column headerText="Usuario recibe" sortBy="#{obs.usuarioRecibe.nombre}" width="15%"
                                		 filterMatchMode="contains" filterBy="#{obs.usuarioRecibe.nombre}">
                                    <h:outputText value="#{obs.usuarioRecibe.nombre}" />
                                </p:column>
                                
                                <p:column headerText="Fecha" sortBy="#{obs.fechaTXT}" width="15%"
                                		 filterMatchMode="contains" filterBy="#{obs.fechaTXT}">
                                    <h:outputText value="#{obs.fechaTXT}" />
                                </p:column>
                                
                                <p:column headerText="Estado" sortBy="#{obs.estado}" width="25%">
                                     <h:outputText value="#{presupuestoBB.listasGenericas.getNombreEstado(obs.estado)}" />
                                </p:column>
                            </p:dataTable>
                            
                        </div>
                        
                        
                        <p:dialog header="Actualizar" id="dlgActualizar" widgetVar="dlgActualizar" minHeight="40">
							<div align="center">
								<h:panelGrid columns="2" cellspacing="2" cellpadding="2">
									
									<h:outputLabel for="txtNombreU" value="Nombre" />
									<p:inputText id="txtNombreU" value="#{presupuestoBB.selectedPresupuesto.nombre}" maxlength="50"/>
									
							   		<p:outputLabel for="txtDescripcionU" value="Descripción"/>
	                                <p:inputText id="txtDescripcionU" value="#{presupuestoBB.selectedPresupuesto.descripcion}" maxlength="100"/>
	                                
	                                <p:outputLabel for="selClasificacion2" value="Clasificación"/>
	                                <p:selectOneMenu id="selClasificacion2" value="#{presupuestoBB.selectedPresupuesto.clasificacion}"
	                                		 filter="true">
	                                    <f:selectItem itemLabel="Seleccione" itemValue="" />
	                                    <f:selectItems value="#{presupuestoBB.listasGenericas.lstClasificacionPpto}" />
	                                </p:selectOneMenu>
	                                
	                                <p:outputLabel for="selCentroCosto2" value="Centro costo"/>
	                                <p:selectOneMenu id="selCentroCosto2" value="#{presupuestoBB.selectedPresupuesto.centroCosto.id}"
	                                		 filter="true">
	                                    <f:selectItem itemLabel="Seleccione" itemValue="" />
	                                    <f:selectItems value="#{presupuestoBB.listaCentroCostos}" var="cc" 
	                                    		itemValue="#{cc.id}" itemLabel="#{cc.centroCosto}"/>
	                                    <p:ajax update="@form" listener="#{presupuestoBB.cargarListaCuentas('SI')}" process="@form" />
	                                </p:selectOneMenu>
	                                
	                                <p:outputLabel for="selCuenta2" value="Cuenta"/>
	                                <p:selectOneMenu id="selCuenta2" value="#{presupuestoBB.selectedPresupuesto.cuenta.id}"
	                                		 filter="true">
	                                    <f:selectItem itemLabel="Seleccione" itemValue="" />
	                                    <f:selectItems value="#{presupuestoBB.listaCuentas}" var="cc" 
	                                    		itemValue="#{cc.id}" itemLabel="#{cc.cuentaNombre}"/>
	                                </p:selectOneMenu>
	                                
	                                <p:outputLabel for="txtAnio2" value="Año"/>
	                                <p:inputNumber id="txtAnio2" value="#{presupuestoBB.selectedPresupuesto.anio}"
	                                		 maxValue="2999" size="10" minValue="0"/>
	                                
	                                <p:outputLabel for="txtTipoU" value="Tipo"/>
	                                <p:selectOneMenu id="txtTipoU" value="#{presupuestoBB.selectedPresupuesto.tipo}"
	                                		 filter="true">
	                                    <f:selectItem itemLabel="Seleccione" itemValue="" />
	                                    <f:selectItems value="#{presupuestoBB.listasGenericas.lstTipoPresupuesto}" />
	                                </p:selectOneMenu>
	                                
	                                <p:outputLabel rendered="#{not empty presupuestoBB.selectedPresupuesto.tipo}"
	                                		value="#{presupuestoBB.selectedPresupuesto.tipo eq 'Mensual' ? 'Mes inicial' : 'Campaña inicial'}"/>
	                                <p:selectOneMenu id="txtMesCam23" value="#{presupuestoBB.selectedPresupuesto.mesCampania}"
	                                		 filter="true" rendered="#{not empty presupuestoBB.selectedPresupuesto.tipo and presupuestoBB.selectedPresupuesto.tipo eq 'Mensual'}">
	                                    <f:selectItem itemLabel="Seleccione" itemValue="" />
	                                    <f:selectItems value="#{presupuestoBB.listasGenericas.lstMeses}"  />
	                                </p:selectOneMenu>
	                                <p:inputNumber id="txtMesCam22" value="#{presupuestoBB.selectedPresupuesto.mesCampania}"
	                                		 maxValue="9999" size="10"
	                                		 rendered="#{not empty presupuestoBB.selectedPresupuesto.tipo and presupuestoBB.selectedPresupuesto.tipo eq 'Campañal'}"/>
	                                
							   	</h:panelGrid>
							   	<br />
						   	
						   		<p:commandButton id="btnActualizarPresupuesto" 
						   				actionListener="#{presupuestoBB.updatePresupuesto}" 
						   				update="@form" title="Actualizar" value="Actualizar" />
								
					   		</div>
						</p:dialog>		
		
						<p:dialog header="Eliminar" id="dlgEliminar" widgetVar="dlgEliminar" minHeight="40">
							<div align="center">
								
								<strong>¿Está seguro de borrar el registro?</strong>
								<br />
								<br />
								<p:commandButton id="btnEliminarPresupuesto" actionListener="#{presupuestoBB.deletePresupuesto}" 
										update="@form" title="Eliminar" value="Eliminar" />						   		
					   		</div>
						</p:dialog>	
						
						<p:dialog header="Enviar al aprobador inicial" id="dlgEnviar" 
								widgetVar="dlgEnviar" minHeight="40">
							<div align="center">
								
								<strong>¿Está seguro de enviar el registro al aprobador inicial?</strong>
								<br /><br /><br />
								<p:inputTextarea value="#{presupuestoBB.observacion.observacion}"/>
								<br /><br />
								<p:spacer width="20px" height="20px" />
								<p:commandButton id="btnEnviarPresupuesto" 
											actionListener="#{presupuestoBB.enviarPresupuestoAprobadorInicial}" 
											update="@form" title="Enviar" value="Enviar" />						   		
					   		</div>
						</p:dialog>	
                        
                        
                    </div>                    
                </div>
            </div>
        </h:form>
    </ui:define>

</ui:composition>
